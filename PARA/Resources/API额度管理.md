# API额度管理 - 贾维斯

## API额度信息

**套餐类型**: 经济型套餐
**额度刷新周期**: 每5小时滚动刷新
**注意**: 不是0点、5点这种固定时间，而是滚动刷新

---

## 额度状态

**当前状态**: 未知（需要检测）
**上次刷新时间**: 未知
**下次刷新时间**: 未知
**剩余额度**: 未知

---

## 额度检测方法

### 如何判断额度耗尽？

当API返回以下错误时，说明额度用完：
```json
{
  "error": "quota_exceeded" 或 "rate_limit" 或 "insufficient_quota"
}
```

### 常见错误信息

- "quota exceeded"
- "rate limit exceeded"
- "insufficient quota"
- "token limit reached"
- "API limit exceeded"

---

## 任务暂停/恢复机制

### 暂停触发条件

当检测到以下情况时，暂停当前任务：
1. API返回额度相关错误
2. 无法完成当前操作
3. 任务还未完成

### 暂停策略

**立即暂停**:
- 停止当前操作
- 保存任务状态（做到哪里了）
- 记录暂停原因（额度耗尽）
- 估算恢复时间

**状态保存**:
- 任务ID和名称
- 已完成步骤
- 下一步要做什么
- 暂停时间
- 预计恢复时间

---

## 恢复策略

### 自动检测

每次收到新任务时：
1. 检查是否有暂停的任务
2. 检查距离上次暂停是否超过5小时
3. 如果超过5小时，尝试恢复

### 恢复步骤

1. **确认额度已刷新**（距离暂停>5小时）
2. **读取任务状态**
3. **从暂停点继续**
4. **完成后标记为完成**
5. **记录恢复时间和结果**

---

## 状态文件

```json
{
  "quota_status": {
    "last_check": "2026-02-03T22:15:00Z",
    "last_pause": null,
    "paused_tasks": [],
    "next_refresh_estimate": "unknown"
  },
  "paused_tasks": [
    {
      "task_id": "任务ID",
      "task_name": "任务名称",
      "paused_at": "暂停时间",
      "progress": "已完成步骤",
      "next_step": "下一步要做什么",
      "reason": "quota_exceeded"
    }
  ]
}
```

---

## HEARTBEAT集成

### 心跳时检查（每30分钟）

每次心跳时：
1. 检查是否有暂停的任务
2. 检查是否超过5小时
3. 如果可以恢复，尝试继续

### 任务开始时检查

每次接到新任务时：
1. 先检查是否有暂停的旧任务
2. 如果有且可以恢复，优先恢复
3. 然后执行新任务

---

## 使用指南

### 对主人说

如果任务被暂停：
- "主人，API额度用完了，任务已暂停。预计5小时后自动恢复。"

如果任务恢复：
- "主人，API额度已刷新，继续执行之前的任务：[任务名]"

如果失败：
- "主人，任务失败：[原因]。需要等待额度刷新。"

---

## 优化建议

### 智能调度

**高额度时段**（刚刷新后）:
- 执行重要/大任务
- 批量操作
- 长时间任务

**低额度时段**（接近刷新前）:
- 执行小任务
- 快速查询
- 准备工作

### 预测机制

记录刷新模式：
- 观察几次刷新时间
- 预测下次刷新时间
- 在刷新前后安排任务

---

## 实施计划

- [x] 创建额度管理系统文档
- [ ] 创建状态文件 `/home/ubuntu/.openclaw/workspace/quota-status.json`
- [ ] 在HEARTBEAT.md中添加额度检查
- [ ] 创建暂停/恢复函数
- [ ] 测试机制

---

## 更新日志

- 2026-02-03 22:15 - 创建额度管理系统
- 2026-02-03 22:15 - 主人告知：API额度5小时滚动刷新
