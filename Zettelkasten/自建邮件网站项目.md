# 自建邮件网站项目 - mail.dhmip.cn

**域名**: mail.dhmip.cn
**技术栈**: PHP + MySQL + Postfix + Dovecot
**创建时间**: 2026-02-04 20:22 GMT+8
**目标时间**: 凌晨0:00-5:00执行

**相关链接**:
- [[HEARTBEAT.md]] - 凌晨自主学习计划
- [[PASSWORDS.md]] - 凭证和配置管理
- [[LNMP环境]] - 已安装的Web环境
- [[Moltbook网红项目]] - 类型的Web开发经验

---

## 🎯 项目目标

创建一个基于Web的邮件系统，实现：
- 📧 Web邮箱界面（收发邮件）
- 👤 用户管理（注册、登录、个人设置）
- 🔐 安全性（SSL/TLS、密码加密）
- 📱 响应式设计（手机、平板、桌面）
- 🛡️ 反垃圾邮件（基础过滤）

---

## 📋 技术方案

### 方案A: 完整邮件服务器（复杂但完整）
**组件**:
1. **MTA** (Mail Transfer Agent): Postfix
   - 发送邮件
   - 接收邮件
   - SMTP服务

2. **MDA** (Mail Delivery Agent): Dovecot
   - 存储邮件
   - IMAP/POP3服务
   - 用户认证

3. **Web界面**: PHP + Roundcube (自建)
   - 用户注册/登录
   - 邮件列表/阅读
   - 发送/回复/转发
   - 文件夹管理
   - 联系人

4. **数据库**: MySQL/MariaDB
   - 用户信息
   - 邮件存储（可选）
   - 配置数据

### 方案B: 纯Web邮件转发（简单但功能有限）
**组件**:
1. **PHP Web界面**
   - 用户注册
   - 邮件发送（通过SMTP）
   - 邮件接收（通过IMAP连接到其他邮箱）

2. **外部邮件服务**
   - 使用Gmail/Outlook作为后端
   - Web界面只是前端

**推荐**: 方案A（完整邮件服务器）

---

## 🔧 LNMP环境检查

当前环境状态：
- ✅ Nginx: 已安装
- ✅ PHP 8.3: 已安装
- ✅ MariaDB: 已安装
- ❌ Postfix: 未安装
- ❌ Dovecot: 未安装

---

## 📝 实施步骤

### 阶段1: 环境准备（0:00-0:30）
1. **安装Postfix**
   ```bash
   yum install postfix -y
   systemctl start postfix
   systemctl enable postfix
   ```

2. **安装Dovecot**
   ```bash
   yum install dovecot dovecot-mysql -y
   systemctl start dovecot
   systemctl enable dovecot
   ```

3. **域名DNS检查**
   ```bash
   dig mail.dhmip.cn
   dig mx dhmip.cn
   ```

### 阶段2: 基础配置（0:30-1:30）
1. **Postfix配置** (`/etc/postfix/main.cf`)
   ```
   myhostname = mail.dhmip.cn
   mydomain = dhmip.cn
   myorigin = $mydomain
   inet_interfaces = all
   mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
   mynetworks = 10.0.0.0/8, 127.0.0.0/8
   home_mailbox = Maildir/
   ```

2. **Dovecot配置**
   - 启用IMAP/POP3
   - 配置MariaDB认证
   - 设置Maildir格式

3. **创建虚拟用户数据库**
   ```sql
   CREATE DATABASE mailserver;
   CREATE TABLE users (
       email VARCHAR(255) PRIMARY KEY,
       password VARCHAR(255),
       quota INT DEFAULT 1024
   );
   ```

### 阶段3: Web界面开发（1:30-3:30）
1. **项目结构**
   ```
   /var/www/html/mail/
   ├── index.php           # 登录页面
   ├── register.php        # 注册页面
   ├── inbox.php           # 收件箱
   ├── compose.php         # 写邮件
   ├── read.php            # 读邮件
   ├── config/
   │   └── db.php          # 数据库配置
   ├── includes/
   │   ├── functions.php   # 核心函数
   │   └── auth.php        # 认证逻辑
   ├── assets/
   │   ├── css/
   │   ├── js/
   │   └── images/
   └── .htaccess
   ```

2. **核心功能开发**
   - ✅ 用户注册/登录
   - ✅ 邮件列表显示
   - ✅ 邮件内容阅读
   - ✅ 发送邮件
   - ✅ 回复/转发
   - ✅ 附件上传
   - ✅ 文件夹管理（收件箱、发件箱、草稿、垃圾箱）

3. **UI/UX设计**
   - 响应式布局（Bootstrap 5）
   - 深色/浅色主题切换
   - AJAX动态加载
   - 实时通知

### 阶段4: 安全加固（3:30-4:30）
1. **SSL/TLS证书**
   ```bash
   # Let's Encrypt证书
   yum install certbot python3-certbot-nginx -y
   certbot --nginx -d mail.dhmip.cn
   ```

2. **安全配置**
   - SMTP认证
   - 强制TLS
   - 反垃圾邮件（SPF、DKIM）
   - 限流配置

3. **PHP安全**
   - 输入验证
   - SQL注入防护
   - XSS防护
   - CSRF令牌

### 阶段5: 测试与优化（4:30-5:00）
1. **功能测试**
   - 发送测试邮件
   - 接收测试邮件
   - 附件上传
   - 多用户测试

2. **性能优化**
   - 数据库索引
   - 缓存机制
   - 日志轮转

3. **图形桌面测试**
   - 在VNC中打开浏览器
   - 测试Web界面
   - 记录和修复bug
   - 截图记录

---

## 🗂️ 数据库设计

### users表（用户）
```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    quota INT DEFAULT 1024,
    active TINYINT(1) DEFAULT 1
);
```

### emails表（邮件元数据）
```sql
CREATE TABLE emails (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    folder ENUM('inbox', 'sent', 'drafts', 'trash') DEFAULT 'inbox',
    from_email VARCHAR(255),
    from_name VARCHAR(255),
    subject VARCHAR(500),
    body TEXT,
    is_read TINYINT(1) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### attachments表（附件）
```sql
CREATE TABLE attachments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email_id INT NOT NULL,
    filename VARCHAR(255) NOT NULL,
    filepath VARCHAR(500) NOT NULL,
    filesize INT NOT NULL,
    FOREIGN KEY (email_id) REFERENCES emails(id) ON DELETE CASCADE
);
```

---

## 🎨 界面功能清单

### 登录/注册页面
- [ ] 邮箱地址输入
- [ ] 密码输入（强度检测）
- [ ] 记住我功能
- [ ] 忘记密码
- [ ] 注册验证码（防机器人）

### 主界面
- [ ] 左侧导航（收件箱、发件箱、草稿、垃圾箱）
- [ ] 邮件列表（分页、排序）
- [ ] 邮件预览
- [ ] 搜索功能
- [ ] 未读标记

### 邮件阅读
- [ ] 邮件详情
- [ ] 发件人信息
- [ ] 附件下载
- [ ] 回复/转发按钮
- [ ] 删除按钮
- [ ] 移动到文件夹

### 写邮件
- [ ] 收件人/抄送/密送
- [ ] 主题输入
- [ ] 富文本编辑器
- [ ] 附件上传（多文件）
- [ ] 保存草稿
- [ ] 定时发送（可选）

---

## 🐛 已知Bug & 待修复

### 待测试
- [ ] CSS在不同浏览器的兼容性
- [ ] 大附件上传性能
- [ ] 并发用户处理
- [ ] 邮件解析（特殊字符、编码）
- [ ] 移动端体验

### 待优化
- [ ] AJAX加载性能
- [ ] 数据库查询优化
- [ ] 缓存策略
- [ ] 日志记录

---

## 📚 参考资料

**文档**:
- Postfix官方文档: https://www.postfix.org/documentation.html
- Dovecot官方文档: https://wiki.dovecot.org/
- PHP IMAP函数: https://www.php.net/manual/zh/book.imap.php

**开源项目参考**:
- Roundcube: https://roundcube.net/
- SnappyMail: https://snappymail.eu/
- AfterLogic WebMail: https://www.afterlogic.com/

---

## ⏰ 时间分配

**凌晨0:00-5:00** (5小时):
- 0:00-0:30 (30分钟): 环境准备
- 0:30-1:30 (1小时): Postfix/Dovecot配置
- 1:30-3:30 (2小时): Web界面开发
- 3:30-4:30 (1小时): 安全加固
- 4:30-5:00 (30分钟): 测试与优化

---

## 🎯 成功标准

- [x] 域名mail.dhmip.cn可访问
- [ ] 可以注册新用户
- [ ] 可以登录
- [ ] 可以发送邮件（到外部邮箱，如Gmail）
- [ ] 可以接收邮件（从外部邮箱）
- [ ] 附件功能正常
- [ ] SSL/TLS加密工作
- [ ] 在图形桌面浏览器测试通过

---

## 📝 备注

- 域名已解析: mail.dhmip.cn → 服务器IP
- LNMP环境已就绪
- 需要配置MX记录: mx.dhmip.cn
- 需要配置SPF记录: dhmip.cn
- 建议使用Let's Encrypt免费SSL证书

---

**最后更新**: 2026-02-04 20:25 GMT+8
**状态**: ⏳ 计划中（凌晨执行）
